<script src="js/libs/jquery-1.8.2/jquery.js"></script>
<script>
"use strict";
var P = {
    key : "json"
    , i : function(value) { this.backup(); localStorage[this.key] = value; }  
    , x : function() { console.log("P.i(\"" + localStorage[this.key].replace(/"/g, "\\\"") + "\")"); }
    , backup : function() { var ls = localStorage, k = this.key; ls[k + 1] = ls[k + 2]; ls[k + 2] = ls[k]; console.log("BACKUP"); }
    , restore : function() { var ls = localStorage, k = this.key; ls[k + 0] = ls[k]; ls[k] = ls[k + 2]; console.log("RESTORE"); }
    , get : function() { var map = localStorage[this.key]; if (map) { this.getGo($("body > ul"), [ 0 ], JSON.parse(map)); } }
    , getGo : function(ul, stack, map) {
        var lis = map[stack.toString()];
        lis = lis ? lis : [];
        for (var i = 0; i < lis.length; i++) {
            var li = ul.data("o").add(lis[i]);
            li.e.addClass("l" + stack.length);
            li.fold.addClass("l" + stack.length);
            stack.push(i);
            this.getGo(li.e.children("ul"), stack, map);
            stack.pop();
        }
        if (stack.length < 3 || ul.children("li").size() < 2) { ul.data("o").toggle(); }
    }
    , set : function() { localStorage[this.key] = this.setGo($("body > ul"), [ 0 ],  {}); }
    , setGo : function(root, stack, map) {
        var list = [];
        root.children("li").each(function (i) {
            list.push($(this).data("o").h.text());
            stack.push(i);
            $(this).children("ul").each(function () { P.setGo($(this), stack, map); });
            stack.pop();
        });
        if (list.length > 1) {
            list.pop();
            map[stack.toString()] = list;
        }
        return JSON.stringify(map);
    }
}
$(function () {
var UL = {
    e : undefined, id : undefined
    , f : function() { var o = Object.create(this);
        o.e = $("<ul>").attr("id", o.id = id()).data("o", o);
        LI.f(o.e, "...").h.unbind("dragstart").click(function() { BIN.set(""); }).dblclick(function() {
            var li = o.add(BIN.get("NEW"));
            if (li.e.siblings().last().hasClass("floating")) {
                li.e.addClass("floating");
            }
            li.ul.toggle();
            P.set();
        });
        return o;
    }
    , toggle : function() { var lis = this.e.children("li"); lis.size() > 1 ? lis.toggleClass("floating") : lis.toggle(); }
    , add : function(text) {
        var li = LI.f(this.e, text);
        li.ul = UL.f();
        li.e.append(li.ul.e).insertBefore(li.e.siblings().last());
        li.h.attr("draggable", true).dblclick(function() { li.h.text(BIN.get(li.h.text())); P.set(); }).click(function() { BIN.set(li.h.text()); });
        li.e.prepend((li.fold = $("<button>")).click(function() { li.ul.toggle(); }));
        return li; 
    }
}
var LI = {  
    e : undefined, h : undefined, ul : undefined, fold : undefined, id : undefined, pid : undefined
    , f : function(parent, text) { var o = Object.create(this);
        o.pid = parent.attr("id");
        parent.append(o.e = $("<li>").addClass("float").data("o", o).attr("id", o.id = id()).append(o.h = $("<span>").append(text)));
        o.h.data("o", o).bind("dragstart", o.dragstart).bind("dragover", o.dragover).bind("drop", o, o.drop);
        return o;
    }
    , dragstart : function(event) { var o = $(this).data("o");
        event.originalEvent.dataTransfer.setData("Text", o.pid + " " + o.id);
    }
    , dragover : function(event) { event.preventDefault(); }
    , drop : function(event) { var o = $(this).data("o");
        var matches = new RegExp("^" + o.pid + " (\\d+.\\d+)$").exec(event.originalEvent.dataTransfer.getData("Text"));
        var matches = new RegExp("^\\d+.\\d+ (\\d+.\\d+)$").exec(event.originalEvent.dataTransfer.getData("Text"));
        if (matches != null && matches[1] != o.id) {
            $(document.getElementById(matches[1])).insertBefore($(document.getElementById(o.id)));
            P.set();
        }
    }
}
var BIN = {
    id : "#BIN", id2 : "BIN", shadow : ""
    , f : function() {
        $("body").prepend($("<input size=100 id=" + this.id2 + " style='position:fixed;top:0px;right:0px'>")
            .dblclick(function() { $(BIN.id).val(BIN.shadow); })
            .bind("dragover", function(e) { e.preventDefault(); }).bind("drop", function(e) {
                var matches = new RegExp("^\\d+.\\d+ (\\d+.\\d+)$").exec(e.originalEvent.dataTransfer.getData("Text"));
                if (matches != null) {
                    $(document.getElementById(matches[1])).remove();
                    P.set();
                }
        }));
    }
    , set : function(value) { BIN.shadow = value; }  
    , get : function(dummy) { var s = $(this.id).val().trim(); $(this.id).val(""); return s.length == 0 ? dummy : s; }
}
function id() { return new Date().getTime() + Math.random(); }
BIN.f(); $("body").append("<p style=margin-top:40px></p>").append(UL.f().e); P.key += location.hash; P.get(); });
</script>
<style>
ul { font-family: Consolas,'Lucida Console',monospace; font-size: 12px; }
button { height: 15px }
button.l1 { background-color: blue }
button.l2 { background-color: yellow }
button.l3 { height: 12px }
button.l4 { height: 11px }
button.l5, button.i6, button.i7, button.i8, button.i9 { height: 10px }
li.l03 { border-color: green }
li.floating { float: left ; padding-right : 3px; border-width: 1px ; border-style: outset } 
.float:after { content: ""; display: table; clear: both }
</style>